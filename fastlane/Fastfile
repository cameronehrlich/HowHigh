# frozen_string_literal: true

require 'fileutils'

# Shared Fastlane configuration for the HowHigh project.
# This file defines lanes you can run locally or in CI.

def metadata_path
  File.expand_path("metadata", __dir__)
end

def screenshots_path
  File.expand_path("screenshots", __dir__)
end

def sanitize_output_directories
  [metadata_path, screenshots_path].each do |path|
    FileUtils.mkdir_p(path)
  end
end

default_platform(:ios)

platform :ios do
  desc "Download localized metadata and (optionally) screenshots from App Store Connect"
  lane :download_metadata do |options|
    sanitize_output_directories

    languages = options[:languages]
    language_array = languages&.split(',')&.map(&:strip)

    deliver(
      force: true,                          # overwrite local metadata files
      skip_binary_upload: true,             # we are not uploading a build
      skip_app_version_update: true,
      skip_metadata: false,
      skip_screenshots: options[:screenshots] ? false : true,
      overwrite_screenshots: options[:screenshots] ? true : false,
      metadata_path: metadata_path,
      screenshots_path: screenshots_path,
      languages: language_array,
      redact_sensitive: false
    )
  end
end
